---
import Layout from "../../layouts/Layout.astro";
import {
    getInviteById,
    getFilmsByInviteId,
} from "../../../backend/pocketbase/backend.mjs";

// Récupérer l'ID de l'invité depuis l'URL
const { id } = Astro.params;

// Vérifier si l'ID est valide
if (!id) {
    return Astro.redirect("/404");
}

// Récupérer les données de l'invité
const invite = await getInviteById(id);

// Vérifier si l'invité existe
if (!invite) {
    return Astro.redirect("/404");
}

// Récupérer les films associés à cet invité (si applicable)
const filmsAssocies = await getFilmsByInviteId(id);

// Formater le rôle avec une majuscule
const roleFormate = invite.role_invite
    ? invite.role_invite.charAt(0).toUpperCase() + invite.role_invite.slice(1)
    : "Invité";

// URL de l'image de l'invité
const photoUrl = invite.photo_invite
    ? `http://127.0.0.1:8090/api/files/Invites/${invite.id}/${invite.photo_invite}`
    : "/placeholder.jpg";

// Titre de la page
const pageTitle = `${invite.prenom_invite} ${invite.nom_invite} - ${roleFormate}`;
---

<Layout title={pageTitle}>
    <div class="container mx-auto px-4 py-8">
        <a
            href="/invites"
            class="inline-flex items-center mb-6 text-(--color-pink) hover:underline"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2"
                viewBox="0 0 20 20"
                fill="currentColor"
            >
                <path
                    fill-rule="evenodd"
                    d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                    clip-rule="evenodd"></path>
            </svg>
            Retour à la liste des invités
        </a>

        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <div class="md:flex">
                <!-- Photo de l'invité -->
                <div class="md:w-1/3">
                    <img
                        src={photoUrl}
                        alt={`Photo de ${invite.prenom_invite} ${invite.nom_invite}`}
                        class="w-full h-auto object-cover md:h-full"
                    />
                </div>

                <!-- Informations de l'invité -->
                <div class="p-6 md:w-2/3 flex flex-col justify-between">
                    <div>
                        <div class="mb-2">
                            <span
                                class="inline-block bg-(--color-pink) text-white text-sm px-3 py-1 rounded-full"
                            >
                                {roleFormate}
                            </span>
                        </div>
                        <h1
                            class="text-3xl font-bold text-(--color-purple) mb-4"
                        >
                            {invite.prenom_invite}
                            {invite.nom_invite}
                        </h1>

                        {
                            invite.biographie_invite && (
                                <div class="prose max-w-none mb-6">
                                    <h2 class="text-xl font-semibold mb-2">
                                        Biographie
                                    </h2>
                                    <p>{invite.biographie_invite}</p>
                                </div>
                            )
                        }
                    </div>

                    {
                        invite.lien_imdb && (
                            <div class="mt-4">
                                <a
                                    href={invite.lien_imdb}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="inline-flex items-center px-4 py-2 bg-(--color-beige) text-(--color-darkpurple) rounded-lg hover:bg-opacity-80 transition-colors"
                                >
                                    Voir sur IMDb
                                </a>
                            </div>
                        )
                    }
                </div>
            </div>
        </div>

        <!-- Films associés à l'invité -->
        {
            filmsAssocies && filmsAssocies.length > 0 && (
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-(--color-purple) mb-4">
                        Films associés
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filmsAssocies.map((film) => (
                            <a
                                href={`/films/${film.id}`}
                                class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow"
                            >
                                <div class="aspect-w-16 aspect-h-9 w-full">
                                    <img
                                        src={`http://127.0.0.1:8090/api/files/Films/${film.id}/${film.affiche_film}`}
                                        alt={`Affiche du film ${film.titre_film}`}
                                        class="w-full h-full object-cover"
                                    />
                                </div>
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-(--color-pink) mb-1">
                                        {film.titre_film}
                                    </h3>
                                    {film.realisateur_film && (
                                        <p class="text-sm text-gray-600 mb-2">
                                            Réalisé par {film.realisateur_film}
                                        </p>
                                    )}
                                    {film.date_heure_film && (
                                        <p class="text-sm text-gray-700">
                                            <span class="font-medium">
                                                Projection:
                                            </span>{" "}
                                            {new Date(
                                                film.date_heure_film,
                                            ).toLocaleDateString("fr-FR", {
                                                day: "numeric",
                                                month: "long",
                                                year: "numeric",
                                                hour: "2-digit",
                                                minute: "2-digit",
                                            })}
                                        </p>
                                    )}
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            )
        }
    </div>
</Layout>
